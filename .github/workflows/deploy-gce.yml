name: Deploy to GCE

on:
  workflow_call:
    inputs:
      tag:
        description: "Release tag (e.g., v1.2.3)"
        required: true
        type: string
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g., v1.2.3)"
        required: true

jobs:
  deploy-gce:
    name: Deploy to GCE
    runs-on: ubuntu-22.04
    environment: mainnet-prod
    permissions:
      contents: read
      id-token: write
    env:
      GCP_PROJECT_ID: ${{ vars.GCP_PROJECT_ID }}
      GCE_ZONE: ${{ vars.GCE_ZONE }}
      INSTANCE_LIST: ${{ vars.GCE_INSTANCE_LIST }}
      ELECTRS_SERVICE: ${{ vars.ELECTRS_SERVICE }}
      ELECTRS_ARGS: ${{ vars.ELECTRS_ARGS }}
      ELECTRS_USER: ${{ vars.ELECTRS_USER }}
      ELECTRS_WORKDIR: ${{ vars.ELECTRS_WORKDIR }}
      ELECTRS_DATA_DIR: ${{ vars.ELECTRS_DATA_DIR }}
      LAYER_RPC_USER: ${{ vars.LAYER_RPC_USER }}
      LAYER_RPC_PASSWORD_SECRET: ${{ vars.LAYER_RPC_PASSWORD_SECRET }}
      ELECTRS_AFTER: ${{ vars.ELECTRS_AFTER }}
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WIF_PROVIDER }}
          service_account: ${{ vars.GCP_WIF_SERVICE_ACCOUNT }}

      - name: Set up gcloud
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.GCP_PROJECT_ID }}

      - name: Deploy release to GCE instances
        env:
          TAG: ${{ inputs.tag }}
        run: |
          set -euo pipefail

          if [ -z "${INSTANCE_LIST}" ]; then
            echo "GCE_INSTANCE_LIST is empty" >&2
            exit 1
          fi

          if [ -z "${TAG}" ]; then
            echo "tag input is required" >&2
            exit 1
          fi

          if [[ ! "${TAG}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "tag must be a stable tag like v1.2.3" >&2
            exit 1
          fi

          VERSION=${TAG#v}

          ARCHIVE="electrs-v${VERSION}-linux-x86_64-musl.tar.gz"
          URL="https://github.com/${GITHUB_REPOSITORY}/releases/download/v${VERSION}/${ARCHIVE}"
          SERVICE_NAME="${ELECTRS_SERVICE:-electrs}"
          SERVICE_USER="${ELECTRS_USER:-opcat}"
          SERVICE_ARGS="${ELECTRS_ARGS:-}"
          SERVICE_WORKDIR="${ELECTRS_WORKDIR:-/var/lib/electrs}"
          SERVICE_DATA_DIR="${ELECTRS_DATA_DIR:-}"
          SERVICE_RPC_USER="${LAYER_RPC_USER:-}"
          SERVICE_RPC_PASSWORD_SECRET="${LAYER_RPC_PASSWORD_SECRET:-}"
          SERVICE_AFTER="${ELECTRS_AFTER:-}"
          SERVICE_URL="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/v${VERSION}/contrib/electrs.service"
          FETCH_COOKIE_URL="https://raw.githubusercontent.com/${GITHUB_REPOSITORY}/v${VERSION}/contrib/electrs-fetch-cookie.sh"

          IFS=',' read -r -a INSTANCES <<< "${INSTANCE_LIST}"

          for INSTANCE in "${INSTANCES[@]}"; do
            ZONE="${GCE_ZONE:-}"
            NAME="${INSTANCE}"
            if [[ "${INSTANCE}" == *"@"* ]]; then
              NAME="${INSTANCE%@*}"
              ZONE="${INSTANCE#*@}"
            fi

            if [ -z "${ZONE}" ]; then
              echo "Missing zone for instance ${NAME}" >&2
              exit 1
            fi

            echo "Deploying to ${NAME} (${ZONE})..."
            gcloud compute ssh "${NAME}" --zone "${ZONE}" --tunnel-through-iap --command "
              set -euo pipefail
              if ! id -u \"${SERVICE_USER}\" >/dev/null 2>&1; then
                echo \"User ${SERVICE_USER} does not exist\" >&2
                exit 1
              fi

              tmpdir=\$(mktemp -d)
              chmod 755 \"\$tmpdir\"
              if ! command -v envsubst >/dev/null 2>&1; then
                sudo apt-get update
                sudo apt-get install -y gettext-base
              fi
              cd \"\$tmpdir\"
              curl -L -o electrs.service ${SERVICE_URL}
              curl -L -o electrs-fetch-cookie.sh ${FETCH_COOKIE_URL}
              curl -L -o ${ARCHIVE} ${URL}
              tar xzf ${ARCHIVE}
              sudo install -m 0755 \"\$tmpdir/electrs-v${VERSION}-linux-x86_64-musl/bin/electrs\" /usr/local/bin/electrs
              sudo install -m 0755 \"\$tmpdir/electrs-fetch-cookie.sh\" /usr/local/bin/electrs-fetch-cookie
              # Create workdir if not exists
              sudo mkdir -p \"${SERVICE_WORKDIR}\"
              sudo chown \"${SERVICE_USER}:${SERVICE_USER}\" \"${SERVICE_WORKDIR}\"
              # Create static environment file
              sudo mkdir -p /etc/electrs
              echo \"ELECTRS_ARGS=${SERVICE_ARGS}\" | sudo tee /etc/electrs/env >/dev/null
              echo \"LAYER_RPC_USER=${SERVICE_RPC_USER}\" | sudo tee -a /etc/electrs/env >/dev/null
              echo \"LAYER_RPC_PASSWORD_SECRET=${SERVICE_RPC_PASSWORD_SECRET}\" | sudo tee -a /etc/electrs/env >/dev/null
              echo \"RUST_BACKTRACE=1\" | sudo tee -a /etc/electrs/env >/dev/null
              sudo chmod 600 /etc/electrs/env
              sudo chown root:root /etc/electrs/env
              # Setup systemd service
              export SERVICE_NAME=\"${SERVICE_NAME}\"
              export SERVICE_USER=\"${SERVICE_USER}\"
              export ELECTRS_WORKDIR=\"${SERVICE_WORKDIR}\"
              export ELECTRS_DATA_DIR=\"${SERVICE_DATA_DIR}\"
              export ELECTRS_AFTER=\"${SERVICE_AFTER}\"
              sudo mkdir -p /etc/systemd/system
              envsubst < \"\$tmpdir/electrs.service\" | sudo tee /etc/systemd/system/${SERVICE_NAME}.service >/dev/null
              sudo systemctl daemon-reload
              sudo systemctl enable ${SERVICE_NAME}
              sudo systemctl restart ${SERVICE_NAME}
            "
          done
